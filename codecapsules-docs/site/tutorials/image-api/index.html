
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Create an API to overlay images with text and a logo">
      
      
      
        <link rel="canonical" href="https://codecapsules.io/docs/tutorials/image-api/">
      
      
        <link rel="prev" href="../build-a-reader-mode-app-with-flask-and-redis/">
      
      
        <link rel="next" href="../build-imgur-clone-uppy-caddy/">
      
      
        
      
      
      <link rel="icon" href="../../assets/cclogo.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.13+insiders-4.32.0">
    
    
      
        <title>Building an Image Overlay API with Express - Code Capsules</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.e95b5de1.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.6932e648.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  <!-- Google Tag Manager -->
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
  j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
  'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-NXT5DSF');</script>
<!-- End Google Tag Manager -->
  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
      
        <meta  property="og:type"  content="website" >
      
        <meta  property="og:title"  content="Building an Image Overlay API with Express - Code Capsules" >
      
        <meta  property="og:description"  content="Create an API to overlay images with text and a logo" >
      
        <meta  property="og:image"  content="https://codecapsules.io/docs/assets/images/social/tutorials/image-api.png" >
      
        <meta  property="og:image:type"  content="image/png" >
      
        <meta  property="og:image:width"  content="1200" >
      
        <meta  property="og:image:height"  content="630" >
      
        <meta  property="og:url"  content="https://codecapsules.io/docs/tutorials/image-api/" >
      
        <meta  name="twitter:card"  content="summary_large_image" >
      
        <meta  name="twitter:title"  content="Building an Image Overlay API with Express - Code Capsules" >
      
        <meta  name="twitter:description"  content="Create an API to overlay images with text and a logo" >
      
        <meta  name="twitter:image"  content="https://codecapsules.io/docs/assets/images/social/tutorials/image-api.png" >
      
    
    
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="codecapsules" />
  <meta name="twitter:creator" content="codecapsules" />
  
      <meta name="twitter:title" content="Building an Image Overlay API with Express" />
      <meta name="twitter:description" content="Create an API to overlay images with text and a logo" />
  

  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#building-an-image-overlay-api-with-express" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Code Capsules" class="md-header__button md-logo" aria-label="Code Capsules" data-md-component="logo">
      
  <img src="../../assets/cclogo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Code Capsules
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Building an Image Overlay API with Express
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6zm0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4zM7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="white" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3Z"/></svg>
            </label>
          
        
      </form>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
    
  
  Getting Started

      </a>
    </li>
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../deployment/" class="md-tabs__link">
          
  
    
  
  Deployment

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../reference/" class="md-tabs__link">
          
  
    
  
  Reference

        </a>
      </li>
    
  

      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item">
        <a href="../" class="md-tabs__link md-tabs__link--active">
          
  
    
  
  Tutorials

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../FAQ/teams-spaces-capsules/" class="md-tabs__link">
          
  
  FAQ

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../comparisons/" class="md-tabs__link">
          
  
    
  
  Comparisons

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../community/introducing-code-capsules/" class="md-tabs__link">
          
  
  Community

        </a>
      </li>
    
  

      
        
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../videos/" class="md-tabs__link">
          
  
    
  
  Video Guides

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Code Capsules" class="md-nav__button md-logo" aria-label="Code Capsules" data-md-component="logo">
      
  <img src="../../assets/cclogo.svg" alt="logo">

    </a>
    Code Capsules
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../deployment/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Deployment
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_2">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Deployment
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-angular-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Angular
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-bootstrap-site-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Bootstrap
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-caddy-docker-site-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Caddy Docker Website
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-static-file-share-flask-caddy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Caddy Docker File Server
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-django-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Django
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-django-mysql-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Django + MySQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-django-mongodb-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Django + MongoDB
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-express-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Express
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-express-mongo-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Express + Mongo
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-flask-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Flask
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-flask-docker-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Flask + Docker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-flask-htmx-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Flask + HTMx
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-flask-mongo-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Flask + MongoDB
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-flask-mysql-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Flask + MySQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-go-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Go
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-static-html-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    HTML
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-html5up-template-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    HTML5up
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-java-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Java (Spring)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-java-mysql-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Java (Spring) + MySQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-docker-php-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    PHP Docker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-docker-laravel-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Laravel Docker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-mean-stack-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    MEAN (Mongo, Express, Angular)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-mern-stack-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    MERN (Mongo, Express, React)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-next-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Next
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-next-mongo-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Next + Mongo
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-next-express-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Next + Express
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-next-express-mongo-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Next + Express + Mongo
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-node-discord-bot-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    NodeJS Discord Bot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-node-telegram-bot-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    NodeJS Telegram Bot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-python-discord-bot-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Python Discord Bot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-python-telegram-bot-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Python Telegram Bot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-polling-node-telegram-bot-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Polling NodeJS Telegram Bot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-polling-python-telegram-bot-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Polling Python Telegram Bot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-react-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    React
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-slack-bot-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Slack
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-svelte-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Svelte
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-vue-application-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Vue
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../deployment/how-to-deploy-whatsapp-bot-to-production/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    WhatsApp
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../reference/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_3">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/capsule-billing/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Capsule Billing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/capsule-management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Capsule Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/how-state-works/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    State and file persistence
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/custom_domains/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Custom Domains
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/set-up-file-data-capsule/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    File Data Capsule
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/set-up-mongodb-data-capsule/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    MongoDB Data Capsule
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/set-up-mysql-data-capsule/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    MySQL Data Capsule
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/set-up-a-redis-data-capsule/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Redis Data Capsule
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/migrating-a-database-with-code-capsules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Running database migrations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/add-procfile-to-backend-application/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Procfile
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/python-development-with-code-capsules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Python Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../reference/team-management/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Team Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_4">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../build-slackbot-with-node/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Slackbot with Node.js
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../build-mern-job-board/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    MERN Job Board
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../build-a-web-file-store/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Web File Store
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../create-nodejs-telegram-bot/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Node.js Telegram Bot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../create-and-host-telegram-bot/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Python Telegram Bot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../creating-and-hosting-a-flask-api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Flask API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../build-hex-color-identifier/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Hex Color Identifier API
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../build-a-docker-php-sqlite-app/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    CRUD with PHP and Docker
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../build-flask-htmx-app/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Flask HTMx
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../build-express-htmx/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Express HTMx
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../generative-art/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Generative Graphics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../customising-domain/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Custom Domains
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../develop-persistent-sleep-tracker-part-1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Persistent Sleep Tracker Part 1
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../develop-persistent-sleep-tracker-part-2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Persistent Sleep Tracker Part 2
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../host-a-frontend/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Front-end Portfolio
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../stripe-checkout-and-email-with-flask/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Stripe Checkout and Email Subscription with Flask
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../game-catalogue-with-nodejs-and-mysql/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Game Catalogue API with Node.js and MySQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../build-a-reader-mode-app-with-flask-and-redis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Reader Mode App with Flask and Redis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    
  
    Image Overlay API with Express
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    
  
    Image Overlay API with Express
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview-and-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview and Requirements
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-the-project" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setting up the Project
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setting up the Project">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-new-repo" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating a New Repo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initializing-the-base-project" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initializing the Base Project
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-packages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installing Packages
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started-with-express" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting Started with Express
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-the-middleware-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Writing the Middleware Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Writing the Middleware Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validation-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Validation Middleware
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-identifier-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create Identifier Middleware
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-background-image-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Download Background Image Middleware
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-logo-image-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Download Logo Image Middleware
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compose-image-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compose Image Middleware
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returning-the-image" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returning the Image
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clean-up-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Clean up Middleware
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-the-api-out" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing the API out
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-commit-and-push-git-changes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Add, Commit, and Push Git Changes
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-to-code-capsules" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deploy to Code Capsules
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Next Steps
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#credits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Credits
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../build-imgur-clone-uppy-caddy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Build an Imgur Clone with Uppy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../white-label-your-app-with-code-capsules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    White-label Your App
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    FAQ
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    FAQ
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../FAQ/teams-spaces-capsules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Teams, Spaces and Capsules
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../FAQ/what-is-a-capsule/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    What is a Capsule?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../FAQ/what-is-a-space/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    What is a Space?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../FAQ/what-is-a-team/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    What is a Team?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../FAQ/how-to-add-custom-domain/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    How Do I Add a Custom Domain?
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
        
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../comparisons/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Comparisons
  

    
  </span>
  
  

            </a>
            
              <label class="md-nav__link " for="__nav_6">
                <span class="md-nav__icon md-icon"></span>
              </label>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Comparisons
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../comparisons/comparing-paas-providers-heroku-vs-digitalocean-vs-code-capsules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    PaaS Providers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../comparisons/comparing-telegram-bot-hosting-providers/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Telegram Hosting Providers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../comparisons/saas-paas-iaas/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    SaaS vs PaaS vs IaaS
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../comparisons/6-heroku-alternatives/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Top Six Heroku Alternatives
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
      
        
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    
  
    Community
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Community
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../community/introducing-code-capsules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Introducing Code Capsules
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../community/codecapsules-hack-days/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Hack Days and Free Tech Consulting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../community/founder-fridays/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    
  
    Founder Fridays
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
      
        
          
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          
          
          <div class="md-nav__link md-nav__container">
            <a href="../../videos/" class="md-nav__link ">
              
  
  <span class="md-ellipsis">
    
  
    Video Guides
  

    
  </span>
  
  

            </a>
            
          </div>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Video Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#overview-and-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Overview and Requirements
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-the-project" class="md-nav__link">
    <span class="md-ellipsis">
      
        Setting up the Project
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Setting up the Project">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-a-new-repo" class="md-nav__link">
    <span class="md-ellipsis">
      
        Creating a New Repo
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#initializing-the-base-project" class="md-nav__link">
    <span class="md-ellipsis">
      
        Initializing the Base Project
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installing-packages" class="md-nav__link">
    <span class="md-ellipsis">
      
        Installing Packages
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#getting-started-with-express" class="md-nav__link">
    <span class="md-ellipsis">
      
        Getting Started with Express
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#writing-the-middleware-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        Writing the Middleware Functions
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Writing the Middleware Functions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validation-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Validation Middleware
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#create-identifier-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Create Identifier Middleware
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-background-image-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Download Background Image Middleware
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#download-logo-image-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Download Logo Image Middleware
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compose-image-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Compose Image Middleware
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#returning-the-image" class="md-nav__link">
    <span class="md-ellipsis">
      
        Returning the Image
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#clean-up-middleware" class="md-nav__link">
    <span class="md-ellipsis">
      
        Clean up Middleware
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#testing-the-api-out" class="md-nav__link">
    <span class="md-ellipsis">
      
        Testing the API out
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#add-commit-and-push-git-changes" class="md-nav__link">
    <span class="md-ellipsis">
      
        Add, Commit, and Push Git Changes
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#deploy-to-code-capsules" class="md-nav__link">
    <span class="md-ellipsis">
      
        Deploy to Code Capsules
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#next-steps" class="md-nav__link">
    <span class="md-ellipsis">
      
        Next Steps
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#credits" class="md-nav__link">
    <span class="md-ellipsis">
      
        Credits
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="building-an-image-overlay-api-with-express">Building an Image Overlay API with Express</h1>
<p><img alt="Cover image" src="../../assets/tutorials/image-api/image-api-cover.png" /></p>
<p>Creating graphics for social media is a common task. Often the final file combines a template image with some headline text and a logo. While creating this type of image can be done fairly easily with a graphics app, it can quickly become boring and tedious if you need to do it often. </p>
<p>Luckily, some programming knowledge can help us out. We can automate the task to give us free time to do other things, like more programming!</p>
<p>In this tutorial, we'll build an <a href="https://www.restapitutorial.com">HTTP REST API</a> to create composite images for social media. </p>
<h2 id="overview-and-requirements">Overview and Requirements</h2>
<p>You'll need the following services and software set up for this tutorial:</p>
<ul>
<li><a href="https://git-scm.com">Git</a> installed and set up, and a registered <a href="https://github.com">GitHub account</a>.</li>
<li><a href="https://nodejs.org/">Node.js</a> installed.</li>
<li>A registered <a href="https://codecapsules.io">Code Capsules</a> account.</li>
<li>An IDE or text editor to create the project in. This tutorial was made using <a href="https://code.visualstudio.com">Visual Studio Code</a>, but feel free to use any tool you like.</li>
</ul>
<h2 id="setting-up-the-project">Setting up the Project</h2>
<p>With our requirements in place, we can get started on setting them up to work as needed for our web file project.</p>
<h3 id="creating-a-new-repo">Creating a New Repo</h3>
<p>We need a place to store our code and from which <a href="https://codecapsules.io">Code Capsules</a> can deploy to a capsule.</p>
<p>Head over to <a href="https://github.com">GitHub</a> and create a new repository. We're calling the repo <code>image-api</code> here, but you can call it whatever you like. You can choose a <strong>Node</strong> <code>.gitignore</code> file to get started.</p>
<p><img alt="Create repository" src="../../assets/tutorials/image-api/init-repo.png" /></p>
<h3 id="initializing-the-base-project">Initializing the Base Project</h3>
<p>Let's get the base code set up. Start by cloning the new GitHub repo onto your local computer and navigate to that directory in a terminal (or command prompt, if you're on Windows).</p>
<p>We can initialize a new Node.js project by typing the following in the terminal:</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>init
</code></pre></div>
<p>You'll be asked a bunch of questions  it's fine to press enter for each of the questions, the defaults are good to start with.</p>
<h3 id="installing-packages">Installing Packages</h3>
<p>Now that we have our project initialized, we can add the packages we will need for our API. These are:</p>
<ul>
<li><a href="http://expressjs.com">Express</a>, to act as our web server and HTTP request router. We'll use Express to route requests from Slack to the correct logic. </li>
<li><a href="https://www.npmjs.com/package/canvas">node-canvas</a>, to put the images together. node-canvas is a graphics library that mimics an HTML canvas element. Canvas elements are 2D graphics elements that can be drawn on.</li>
</ul>
<p>Type the following in the terminal to install the packages:</p>
<div class="highlight"><pre><span></span><code>npm<span class="w"> </span>install<span class="w"> </span>express<span class="w"> </span>canvas
</code></pre></div>
<p>Now let's create an <code>index.js</code> file, which will be the main file for our app. An easy way to do this is to open up your project folder in an editor like <a href="https://code.visualstudio.com/">Visual Studio Code</a>. Now you can create a new <code>index.js</code> file. </p>
<p><img alt="create index.js in visual studio" src="../../assets/tutorials/image-api/create-indexjs.gif" /></p>
<p>Save this blank file. </p>
<p>We also have a font file that we'll need to add to the project. Download and copy <a href="https://github.com/codecapsules-io/image-overlay-api/blob/main/ShortBaby.ttf">this font</a> to your project folder.</p>
<p>Great, it's time to push this boilerplate project up to Git. We can do it with the following from the command prompt or terminal: </p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>.<span class="w"> </span>
git<span class="w"> </span>commit<span class="w"> </span>-am<span class="w"> </span><span class="s1">&#39;added libraries, index.js and font&#39;</span>
git<span class="w"> </span>push<span class="w"> </span>origin
</code></pre></div>
<h2 id="getting-started-with-express">Getting Started with Express</h2>
<p>Let's define the inputs and interface of the API to build. We need the user to provide three elements:</p>
<ul>
<li>A URL to an image to use as the <code>background</code>.</li>
<li>Headline <code>text</code> to render over the image.</li>
<li>A URL to a <code>logo</code> to use in the image.</li>
</ul>
<p>A call to the API should look similar to this: </p>
<p><div class="highlight"><pre><span></span><code>https://image-api.codecapsules.co.za?background<span class="o">=</span>https://example.com/background.png<span class="p">&amp;</span><span class="nv">logo</span><span class="o">=</span>https://example.com/logo.png<span class="p">&amp;</span><span class="nv">text</span><span class="o">=</span>my<span class="w"> </span>inspirational<span class="w"> </span>message
</code></pre></div>
When calling an API, the parameters are separated by <code>&amp;</code> and the key-value pairs are separated by <code>=</code>. The values are also typically URL encoded to ensure they are not misinterpreted. The above call URL encoded would be:</p>
<div class="highlight"><pre><span></span><code>https://image-api.codecapsules.co.za?background<span class="o">=</span>https%3A%2F%2Fexample.com%2Fbackground.png<span class="p">&amp;</span><span class="nv">logo</span><span class="o">=</span>https%3A%2F%2Fexample.com%2Flogo.png<span class="p">&amp;</span><span class="nv">text</span><span class="o">=</span>my%20inspirational%20message
</code></pre></div>
<p><a href="http://expressjs.com">Express</a> is a popular and well established API framework for Node.js. It is built around the concept of <em>middleware</em> functions. Middleware functions are chained together to provide a processing pipeline for an API request. Let's take a brief look at what that means. </p>
<p>A basic Express API route looks something like this:</p>
<div class="highlight"><pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;Hello World!&quot;</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>In this example, <code>app</code> refers to an Express application, which provides all the API functionality. The <code>"/"</code> defines the URL endpoint. In this case, it is just the root of the API. The inline function is the route handler, which takes the incoming request <code>req</code>, and provides an object to return the API's result <code>res</code>. </p>
<p>This would be enough to create the image API, as we could put all the code in the one route handler function. However, because Express enables multiple middleware functions to be chained together, we can split our code up more logically. Express allows a route to have multiple chained functions, which are run one after the other. Instead of passing the route one route handler, Express allows us to pass an array of them, like this: </p>
<p><div class="highlight"><pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// do something</span>
<span class="w">  </span><span class="nx">next</span><span class="p">();</span>
<span class="p">},</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// do something else</span>
<span class="w">  </span><span class="nx">next</span><span class="p">();</span>
<span class="p">},</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// send the response</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;Hello World!&quot;</span><span class="p">);</span>
<span class="p">}]);</span>
</code></pre></div>
Notice that the <code>next()</code> function is called after each middleware function has completed its particular function. This is how we can chain together multiple middleware functions.</p>
<p>The functions don't have to be inline  we can use named functions. This makes the code very readable, and it's like writing down the steps we need to take. We can then implement the functions one at a time. </p>
<p>If we were to break down the processing that the image API needs to do, one sequence could be: </p>
<ul>
<li>Validate the incoming request for the required parameters.</li>
<li>Create a unique identifier for the request, so that multiple requests can be handled in parallel.</li>
<li>Download the background image from the given URL.</li>
<li>Download the logo image from the given URL.</li>
<li>Combine the two images, along with the text.</li>
<li>Send the image back to the caller.</li>
<li>Clean up the downloaded and temporary files made. </li>
</ul>
<p>If we write this as a series of middleware functions for the route, it would look something like this:</p>
<div class="highlight"><pre><span></span><code><span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="nx">validateRequest</span><span class="p">,</span>
<span class="w">  </span><span class="nx">createIdentifier</span><span class="p">,</span>
<span class="w">  </span><span class="nx">downloadBackground</span><span class="p">,</span>
<span class="w">  </span><span class="nx">downloadLogo</span><span class="p">,</span>
<span class="w">  </span><span class="nx">composeImage</span><span class="p">,</span>
<span class="w">  </span><span class="nx">sendImage</span><span class="p">,</span>
<span class="w">  </span><span class="nx">cleanupFiles</span><span class="p">,</span>
<span class="p">]);</span>
</code></pre></div>
<p>This is a very readable way to write the code. It becomes clear to others what steps the API route takes, and the order that it takes them. We can implement each of the steps one at a time.</p>
<p>Let's start by adding the above code to the <code>index.js</code> file. We'll also need to import the Express library and set up the Express app. Put together, we can add the following code to the <code>index.js</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;express&quot;</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;3000&#39;</span><span class="p">;</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[</span>
<span class="w">  </span><span class="nx">validateRequest</span><span class="p">,</span>
<span class="w">  </span><span class="nx">createIdentifier</span><span class="p">,</span>
<span class="w">  </span><span class="nx">downloadBackground</span><span class="p">,</span>
<span class="w">  </span><span class="nx">downloadLogo</span><span class="p">,</span>
<span class="w">  </span><span class="nx">composeImage</span><span class="p">,</span>
<span class="w">  </span><span class="nx">sendImage</span><span class="p">,</span>
<span class="w">  </span><span class="nx">cleanupFiles</span><span class="p">,</span>
<span class="p">]);</span>

<span class="c1">// Add the middleware function implementations below this line</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Image API listening on port </span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">!`</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<ul>
<li>The first line imports the Express library. </li>
<li>The second line creates the Express app. </li>
<li>The third line sets the port to listen on. This is normally passed in as an environment variable <code>process.env.PORT</code> when the application is hosted. We provide a default value of <code>3000</code> if the environment variable is not set.</li>
<li>Then we have the route handler and the calls to the middleware functions. We'll implement these functions in the next section.</li>
<li>Finally, we call the <code>app.listen()</code> function to start the server on the given port.</li>
</ul>
<h2 id="writing-the-middleware-functions">Writing the Middleware Functions</h2>
<p>Now that we have the outline of the API and a list of all the middleware we need to write, we can implement each step. </p>
<h3 id="validation-middleware">Validation Middleware</h3>
<p>To validate the request, we'll need to check that the request contains the required parameters. Express provides a <code>req</code> object that contains all the information about the request. The <code>req</code> object has a <code>query</code> property that contains the query parameters. We can use this to check that the request contains the required parameters. If it doesn't, we can return an HTTP <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status"><code>400</code></a> error, which means that the there was something wrong with the request from the caller. We'll also provide a helpful message to the caller, so they are not left guessing what they did wrong. Add the following function just below the <code>Add the middleware functions below this line</code> comment.</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">validateRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">background</span><span class="p">){</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;missing background&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">logo</span><span class="p">){</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;missing logo&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">text</span><span class="p">){</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;missing text&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">next</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="create-identifier-middleware">Create Identifier Middleware</h3>
<p>Next up, we need to create a unique identifier for the request. This is because we'll be downloading the images from the request URLs, and we'll be creating an output composite image. We'll want to create a unique name, so that it's easy to refer to the images, and so that we can handle multiple requests in parallel. If we just called the downloaded images <code>background</code> and <code>logo</code> for example, as one request is being served, the files might get overwritten by another incoming request. We'd get the images crossed, and probably end up with some very strange end results. </p>
<p>To create a unique identifier, we could just create a random number. This would work a lot of the time, but there is a chance that the same number could be chosen. Luckily, this problem has been solved with the very clever invention of something called a <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">Universally Unique Identifier</a>, or UUID for short. They are also known as Globally Unique Identifiers, or GUIDs. UUIDs / GUIDs are a type of randomly generated identifier that is virtually guaranteed to be unique - in the whole world, not just our project!</p>
<p>Node has a built-in cryptography module <code>crypto</code> that can create UUIDs. We can import the <code>crypto</code> module by adding the following <code>require</code> line to the top of the <code>index.js</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">crypto</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">);</span>
</code></pre></div>
<p>Now let's implement the <code>createIdentifier</code> middleware function. Add the following function just below the previous middleware function:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">createIdentifier</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">identifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">crypto</span><span class="p">.</span><span class="nx">randomUUID</span><span class="p">();</span>
<span class="w">  </span><span class="nx">req</span><span class="p">.</span><span class="nx">identifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">identifier</span><span class="p">;</span>
<span class="w">  </span><span class="nx">next</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>This function creates a random UUID and stores it in the <code>req</code> object. Since the <code>req</code> object is passed to each of the following middleware functions, we can access this identifier in all of the subsequent functions. You can store all kinds of information on the <code>req</code> object - it's sort of like a backpack that you can put stuff in and carry through all the middleware functions.</p>
<h3 id="download-background-image-middleware">Download Background Image Middleware</h3>
<p>Next up is the <code>downloadBackground</code> function. We need to make a web call to the URL provided by the caller, and save the image to work with later. We'll use the built-in <code>https</code> module to make the web call, and the <code>fs</code> module to save the image to a temporary location.</p>
<p>First, we'll need to import the <code>https</code> and <code>fs</code> modules. Add the following <code>require</code> lines to the top of the <code>index.js</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;fs&quot;</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;https&quot;</span><span class="p">);</span>
</code></pre></div>
<p>Now let's use these imports in the <code>downloadBackground</code> function. Add the following function just below the previous middleware function.</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">downloadBackground</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">background</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="sb">`./</span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">identifier</span><span class="si">}</span><span class="sb">-background.jpg`</span><span class="p">);</span>

<span class="w">  </span><span class="nx">client</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">webRes</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">webRes</span><span class="p">.</span><span class="nx">statusCode</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">200</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">webRes</span><span class="p">.</span><span class="nx">statusCode</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">299</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="sb">`Got status code </span><span class="si">${</span><span class="nx">webRes</span><span class="p">.</span><span class="nx">statusCode</span><span class="si">}</span><span class="sb"> while downloading background`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">webRes</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">file</span><span class="p">).</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">next</span><span class="p">();</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,(</span><span class="nx">err</span><span class="p">)=&gt;{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error downloading background&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>Here we retrieve the URL of the image to download from the <code>req</code> object. This is stored in the <code>req.query.background</code> property. Then we create a file stream to write the image to. We'll use the <code>fs</code> module to create the file stream, using the <a href="https://nodejs.org/dist/latest-v16.x/docs/api/fs.html#filehandlecreatewritestreamoptions"><code>createWriteStream()</code></a> function. The argument to this function is the path to the file we want to write to. Notice that we combine the <code>identifier</code> we added to the <code>req</code>, along with the word <code>background</code> to make a unique filename.</p>
<p>Then we make the web call to the URL. We use the built-in <code>https</code> module, using its <a href="https://nodejs.org/dist/latest-v16.x/docs/api/https.html#httpsgeturl-options-callback"><code>get()</code></a> function to make the web call. The first argument to this function is the URL to download the image from. The second argument is a callback function that is called when the web call is complete. The callback function passes a web response object to the callback.</p>
<p>We can check this web response object <code>webRes</code> to see if the web call was successful. A simple (but not totally foolproof) way of checking if the call was successful is to check the status code. By convention, web servers should return an <code>OK</code> code, which is generally a code within the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status#successful_responses">200-299 range</a>. Therefore, if the status code is less than 200 or greater than 299, we can return an error and exit early. Note that by calling <code>res.send</code> early, we prevent the next middleware function from being called.</p>
<p>If the web call was successful, we <a href="https://nodejs.org/en/knowledge/advanced/streams/how-to-use-stream-pipe/">pipe</a> the web response to the file stream. This means that the web response will be written to the file stream. When the web response is complete, the file stream is closed. We can check if the file stream is closed by listening for the <a href="https://nodejs.org/dist/latest/docs/api/stream.html#event-close"><code>close</code></a> event. When the file stream is closed, we call the <code>next()</code> function to move on to the next middleware function.</p>
<p>The <code>https</code> client also has an <code>error</code> event that we can listen for. Should any other errors occur, such as network errors, we return an error and exit early.</p>
<h3 id="download-logo-image-middleware">Download Logo Image Middleware</h3>
<p>To download the logo, we'll need to do the same thing as we did for the background image. Add the following function under the <code>downloadBackground</code> function.</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span><span class="w"> </span><span class="nx">downloadLogo</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">logo</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">createWriteStream</span><span class="p">(</span><span class="sb">`./</span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">identifier</span><span class="si">}</span><span class="sb">-logo.jpg`</span><span class="p">);</span>

<span class="w">  </span><span class="nx">client</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">webRes</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">webRes</span><span class="p">.</span><span class="nx">statusCode</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">200</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">webRes</span><span class="p">.</span><span class="nx">statusCode</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">299</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">400</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="sb">`Got status code </span><span class="si">${</span><span class="nx">webRes</span><span class="p">.</span><span class="nx">statusCode</span><span class="si">}</span><span class="sb"> while downloading logo`</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">webRes</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">file</span><span class="p">).</span><span class="nx">once</span><span class="p">(</span><span class="s2">&quot;close&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">next</span><span class="p">();</span>
<span class="w">    </span><span class="p">});</span>
<span class="w">  </span><span class="p">}).</span><span class="nx">on</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,(</span><span class="nx">err</span><span class="p">)=&gt;{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mf">500</span><span class="p">).</span><span class="nx">send</span><span class="p">(</span><span class="s2">&quot;error downloading logo&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<h3 id="compose-image-middleware">Compose Image Middleware</h3>
<p>Now we get to the heart of the API's function: putting the images and text together in a composition. The <a href="https://www.npmjs.com/package/canvas"><code>canvas</code></a> module can do all of this for us. First, we'll need to import the <code>canvas</code> module. Add the following <code>require</code> line to the top of the <code>index.js</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">createCanvas</span><span class="p">,</span><span class="w"> </span><span class="nx">loadImage</span><span class="p">,</span><span class="w"> </span><span class="nx">registerFont</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">&quot;canvas&quot;</span><span class="p">);</span>
</code></pre></div>
<p>This imports two functions that we'll need from the <code>canvas</code> module. The <code>createCanvas</code> function creates a canvas object that we can draw our composite image on, and the <code>loadImage</code> function loads images from the file system. Using <code>loadImage</code> we can load the images we downloaded earlier, and then draw them to the canvas to create our composite image.</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">composeImage</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">loadImage</span><span class="p">(</span><span class="sb">`./</span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">identifier</span><span class="si">}</span><span class="sb">-background.jpg`</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">logo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">loadImage</span><span class="p">(</span><span class="sb">`./</span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">identifier</span><span class="si">}</span><span class="sb">-logo.jpg`</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">background</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">background</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>

<span class="w">  </span><span class="nx">registerFont</span><span class="p">(</span><span class="s2">&quot;./ShortBaby.ttf&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">family</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;ShortBaby&quot;</span><span class="w"> </span><span class="p">});</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">canvas</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">createCanvas</span><span class="p">(</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="p">);</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">context</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="s2">&quot;2d&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">logoPadding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">20</span><span class="p">;</span>
<span class="w">  </span><span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">background</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="p">);</span>
<span class="w">  </span><span class="nx">context</span><span class="p">.</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">logo</span><span class="p">,</span><span class="w"> </span><span class="nx">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">logo</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">logoPadding</span><span class="p">,</span><span class="w"> </span><span class="nx">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">logo</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">logoPadding</span><span class="p">);</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">textPadding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">30</span><span class="p">;</span>
<span class="w">  </span><span class="nx">context</span><span class="p">.</span><span class="nx">font</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;bold 70pt ShortBaby&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">context</span><span class="p">.</span><span class="nx">textAlign</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;left&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">context</span><span class="p">.</span><span class="nx">textBaseline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;top&quot;</span><span class="p">;</span>

<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">textSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">measureText</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
<span class="w">  </span><span class="nx">context</span><span class="p">.</span><span class="nx">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;rgba(255, 255, 255, 0.8)&quot;</span>
<span class="w">  </span><span class="nx">context</span><span class="p">.</span><span class="nx">fillRect</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">textSize</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2</span><span class="o">*</span><span class="nx">textPadding</span><span class="p">,</span><span class="w"> </span><span class="mf">200</span><span class="p">);</span>

<span class="w">  </span><span class="nx">context</span><span class="p">.</span><span class="nx">fillStyle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;#444&quot;</span><span class="p">;</span>
<span class="w">  </span><span class="nx">context</span><span class="p">.</span><span class="nx">fillText</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">text</span><span class="p">,</span><span class="w"> </span><span class="nx">textPadding</span><span class="p">,</span><span class="w"> </span><span class="nx">textPadding</span><span class="p">);</span>


<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">buffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">toBuffer</span><span class="p">(</span><span class="s2">&quot;image/png&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">req</span><span class="p">.</span><span class="nx">compositeImageBuffer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">buffer</span><span class="p">;</span>
<span class="w">  </span><span class="nx">next</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<p>There is quite a bit of code in this function, so let's break it down. In the first two lines, we load up the <code>background</code> and <code>logo</code> images from file using the <code>loadImage</code> function, along with the identifier we stored in the <code>req</code> object. </p>
<p>In the following two lines, we extract and store the width and height of the background image. Then we load up our font to use, before creating a new, blank canvas object with these dimensions. A blank canvas is like opening up Paint and creating a new file. After we create the canvas, we get a reference to the context of the canvas. The context is the interface to the canvas, and it's the way we draw onto the canvas. It has all the functions to add images, text, shapes, fills, etc. to your canvas. You can think of it as equivalent to the tools palette in Paint or Photoshop, with all the brushes, pens, buckets, etc. </p>
<p>Because we want the logo to be a little indented from the right and bottom of the background image, we use the <code>logoPadding</code> variable to define the amount of padding we want. Then we draw the background image to the canvas, using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage"><code>drawImage()</code></a> function. The first argument to this function is the image we want to draw, and the second and third arguments are the x- and y-coordinates of where we'll place the top left corner of the image. The next two coordinates are the width and height of the image we want to draw. </p>
<p>Then we draw the logo image to the canvas using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/drawImage"><code>drawImage()</code></a> function again. This time, we place it at the bottom right corner of the canvas, adjusted by the padding amount. </p>
<p>Now we need to add the text to the image. We define a padding value for the text, as we want it offset from the sides of the image. We use the <code>textPadding</code> variable to define this amount. Then we define the font and size we want the text to be, along with the alignment when we draw it. </p>
<p>Text drawn straight onto an image can be difficult to read, especially if the image has colors close to the text. To solve this problem, we'll first draw a background rectangle behind the text. This will give us a nice contrast between the text and the background. To find out how wide this background should be, we use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/measureText"><code>measureText()</code></a> function. This function returns an object with the dimensions in pixels of the area the text will occupy, given the set font and size. We also set the <code>fillStyle</code> to specify the color the background should be. We're using <code>rgba</code> notation, which specifies the red, green, blue, and alpha values for the color. Alpha is the amount of transparency the fill should have, on a scale from 0 (totally transparent) to 1 (totally opaque). We then use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/fillRect"><code>fillRect()</code></a> function to draw the background rectangle. The first two arguments are the x- and y-coordinates of the top left corner of the rectangle, and the next two arguments are the width and height of the rectangle. We pad the edges of the background rectangle a bit to make sure the text is not too close to the edges of the background. </p>
<p>Now we can finally draw the text. First thing is to set the font on the context, and specify the alignment. Then we change the <code>fillStyle</code> to the color we want for the text. This time, we're using <a href="https://www.w3schools.com/htmL/html_colors_hex.asp">Hex notation</a> for the color, in RGB order. The code <code>#444</code> is dark gray. Then we use the <a href="https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D/fillText"><code>fillText()</code></a> function to draw the text. The first argument is the text we want to draw, and the next two arguments are the x- and y-coordinates of the top left corner of where we want to draw the text. This is our padding offset. </p>
<p>Finally, we use the <a href="https://github.com/Automattic/node-canvas#canvastobuffer"><code>toBuffer()</code></a> function to convert the canvas to a buffer, which is a binary representation of the image that we can use to write an image file. We then use the same trick we used to store the <code>identifier</code> on the request object <code>req</code>, so that it is available to the next middleware function to use.</p>
<h3 id="returning-the-image">Returning the Image</h3>
<p>Now we need to send the image back to the API caller. Add the following function after the <code>composeImage</code> function:</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">sendImage</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">&quot;Content-Type&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;image/png&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">compositeImageBuffer</span><span class="p">);</span>
<span class="w">  </span><span class="nx">next</span><span class="p">();</span><span class="w"> </span>
<span class="p">}</span>
</code></pre></div>
<p>This function sets the header's <code>Content-Type</code> to <code>image/png</code>, which lets the API caller know the data type to expect. Then we use the <a href="http://expressjs.com/en/api.html#res.send"><code>send</code></a> function on the result object <code>res</code> to send the image buffer we saved onto the <code>req</code> object back to the API caller. Then we call <code>next()</code> to move on to the next function in the pipeline.</p>
<h3 id="clean-up-middleware">Clean up Middleware</h3>
<p>The next step is to clean up the downloaded files, as we don't need them once the image has been created and sent back to the API caller. We add empty callbacks, as we don't really need the result of the operation. In a production system, you might log the result in case there is an error when deleting. Add the following function after the <code>sendImage</code> function:</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">cleanupFiles</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">,</span><span class="w"> </span><span class="nx">next</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="sb">`./</span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">identifier</span><span class="si">}</span><span class="sb">-background.jpg`</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{});</span>
<span class="w">  </span><span class="nx">fs</span><span class="p">.</span><span class="nx">unlink</span><span class="p">(</span><span class="sb">`./</span><span class="si">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">identifier</span><span class="si">}</span><span class="sb">-logo.jpg`</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{});</span>
<span class="w">  </span><span class="nx">next</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div>
<h2 id="testing-the-api-out">Testing the API out</h2>
<p>Now that the API is complete, we can test it out. First we need to start the API. From a terminal, run the following command:</p>
<p><div class="highlight"><pre><span></span><code>node<span class="w"> </span>index.js
</code></pre></div>
You should see the message <code>Image API listening on port 3000</code> in the terminal. Our API is now listening for requests on port 3000.</p>
<p>Let's test our API out with some example images and text. We'll use the <a href="https://codecapsules.io/assets/images/v2/logo-code-capsules-brand-dark.svg">Code Capsules logo</a>, and a stock image background image we've <a href="https://codecapsules.io/docs/assets/tutorials/image-api/background.png">linked here</a>. And of course, for the text, we'll use the classic "Hello World".</p>
<p>Combining all this into the URL to call our API looks like this:</p>
<div class="highlight"><pre><span></span><code>http://localhost:3000?background<span class="o">=</span>https://codecapsules.io/docs/assets/tutorials/image-api/background.png<span class="p">&amp;</span><span class="nv">logo</span><span class="o">=</span>https://codecapsules.io/assets/images/v2/logo-code-capsules-brand-dark.svg<span class="p">&amp;</span><span class="nv">text</span><span class="o">=</span>Hello<span class="w"> </span>World
</code></pre></div>
<p>As we discussed earlier, before we call this, we need to URL encode the parameters. There are a few online services to do this, like <a href="https://www.urlencoder.io">https://www.urlencoder.io</a>. After encoding the URL, it should look like this: </p>
<div class="highlight"><pre><span></span><code>http://localhost:3000?background<span class="o">=</span>https%3A%2F%2Fcodecapsules.io%2Fdocs%2Fassets%2Ftutorials%2Fimage-api%2Fbackground.png<span class="p">&amp;</span><span class="nv">logo</span><span class="o">=</span>https%3A%2F%2Fcodecapsules.io%2Fassets%2Fimages%2Fv2%2Flogo-code-capsules-brand-dark.svg<span class="p">&amp;</span><span class="nv">text</span><span class="o">=</span>Hello%20World
</code></pre></div>
<p>If you have <a href="https://curl.se"><code>curl</code></a> installed, you can use the following command to test it out:</p>
<p><div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span><span class="s2">&quot;http://localhost:3000?background=https%3A%2F%2Fcodecapsules.io%2Fdocs%2Fassets%2Ftutorials%2Fimage-api%2Fbackground.png&amp;logo=https%3A%2F%2Fcodecapsules.io%2Fassets%2Fimages%2Fv2%2Flogo-code-capsules-brand-dark.svg&amp;text=Hello%20World&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>output.png
</code></pre></div>
This will create the image, and save it to the file <code>output.png</code>. Open it up, and you should see the following:</p>
<p><img alt="composite image from the api" src="../../assets/tutorials/image-api/output.png" /></p>
<p>You can also test it out directly in the browser by visiting the following URL:</p>
<div class="highlight"><pre><span></span><code>http://localhost:3000?background<span class="o">=</span>https%3A%2F%2Fcodecapsules.io%2Fdocs%2Fassets%2Ftutorials%2Fimage-api%2Fbackground.png<span class="p">&amp;</span><span class="nv">logo</span><span class="o">=</span>https%3A%2F%2Fcodecapsules.io%2Fassets%2Fimages%2Fv2%2Flogo-code-capsules-brand-dark.svg<span class="p">&amp;</span><span class="nv">text</span><span class="o">=</span>Hello%20World
</code></pre></div>
<h2 id="add-commit-and-push-git-changes">Add, Commit, and Push Git Changes</h2>
<p>Let's add and commit all the files we created to our local repository and then push them to the remote one. Do this by running the commands listed below in a terminal while in the projects root folder:</p>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>add<span class="w"> </span>-a
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Added image editing files&quot;</span>
git<span class="w"> </span>push<span class="w"> </span>-u<span class="w"> </span>origin<span class="w"> </span>main
</code></pre></div>
<p>Your remote repository will now be up to date with your local one.</p>
<h2 id="deploy-to-code-capsules">Deploy to Code Capsules</h2>
<p>The final step is to deploy our app. Log in to your Code Capsules account and link your remote GitHub repository to Code Capsules. Create a Backend Capsule to deploy your app. You can follow <a href="https://codecapsules.io/docs/deployment/how-to-deploy-express-application-to-production/">this deployment guide</a> to see how to do so in greater detail.</p>
<p>Thats it! Your image editing app should be live and fully functional now.</p>
<h2 id="next-steps">Next Steps</h2>
<p>Nice work on building an API! Hopefully you've seen the possibilities of building APIs with Node.js and Express. If you'd like to learn more about Express, check out <a href="https://expressjs.com/">the Express website</a>.</p>
<p>Some things you can do to improve the API or just to experiment with it are:</p>
<ul>
<li>Allow the font to be passed as a parameter.</li>
<li>Allow text color and background to be passed as a parameter.</li>
<li>We use the <code>https</code> module to download the images. This only supports HTTPS requests. We can use the <code>http</code> module to download the images if we want to support HTTP requests as well. Or you can try another HTTP client library like <a href="https://www.npmjs.com/package/axios"><code>axios</code></a>.</li>
<li>Advanced: Specify the resulting image size, and how it should resize the background.</li>
</ul>
<h2 id="credits">Credits</h2>
<p>The background image we used is from <a href="https://opengameart.org/content/background-3">https://opengameart.org/content/background-3</a>.</p>
<p>The font "ShortBaby" is from <a href="https://www.fontspace.com/short-baby-font-f34907">https://www.fontspace.com/short-baby-font-f34907</a>.</p>
<p>The logo is from Code Capsules. </p>

  
  



  



  <form class="md-feedback" name="feedback" hidden>
    <fieldset>
      <legend class="md-feedback__title">
        Was this page helpful?
      </legend>
      <div class="md-feedback__inner">
        <div class="md-feedback__list">
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page was helpful" data-md-value="1">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m7 0c0 .8-.7 1.5-1.5 1.5S14 10.3 14 9.5 14.7 8 15.5 8s1.5.7 1.5 1.5m-5 7.73c-1.75 0-3.29-.73-4.19-1.81L9.23 14c.45.72 1.52 1.23 2.77 1.23s2.32-.51 2.77-1.23l1.42 1.42c-.9 1.08-2.44 1.81-4.19 1.81Z"/></svg>
            </button>
          
            <button class="md-feedback__icon md-icon" type="submit" title="This page could be improved" data-md-value="0">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 12a8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8 8 8 0 0 0 8-8m2 0a10 10 0 0 1-10 10A10 10 0 0 1 2 12 10 10 0 0 1 12 2a10 10 0 0 1 10 10m-6.5-4c.8 0 1.5.7 1.5 1.5s-.7 1.5-1.5 1.5-1.5-.7-1.5-1.5.7-1.5 1.5-1.5M10 9.5c0 .8-.7 1.5-1.5 1.5S7 10.3 7 9.5 7.7 8 8.5 8s1.5.7 1.5 1.5m2 4.5c1.75 0 3.29.72 4.19 1.81l-1.42 1.42C14.32 16.5 13.25 16 12 16s-2.32.5-2.77 1.23l-1.42-1.42C8.71 14.72 10.25 14 12 14Z"/></svg>
            </button>
          
        </div>
        <div class="md-feedback__note">
          
            <div data-md-value="1" hidden>
              
              
                
              
              Thanks for your feedback!
            </div>
          
            <div data-md-value="0" hidden>
              
              
                
              
              Thanks for your feedback! We'll do our best to improve.
            </div>
          
        </div>
      </div>
    </fieldset>
  </form>


                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.indexes", "navigation.tabs", "navigation.sections"], "search": "../../assets/javascripts/workers/search.6c7302c4.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    

      <script src="../../assets/javascripts/bundle.b7178837.min.js"></script>
      
    
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NXT5DSF"
                  height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

  </body>
</html>